{"ast":null,"code":"import _slicedToArray from\"/home/vedant/go/src/github.com/litmus/litmus-portal/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useQuery,useSubscription}from'@apollo/client';import{Tabs,Typography,useTheme}from'@material-ui/core';import{ButtonFilled}from'litmus-ui';import React,{useEffect,useState}from'react';import{useTranslation}from'react-i18next';import{useSelector}from'react-redux';import YAML from'yaml';import{StyledTab,TabPanel}from'../../../components/Tabs';import{WORKFLOW_DETAILS_WITH_EXEC_DATA,WORKFLOW_LOGS}from'../../../graphql';import{getProjectID}from'../../../utils/getSearchParams';import useStyles from'./styles';var LogsSwitcher=function LogsSwitcher(_ref){var cluster_id=_ref.cluster_id,workflow_run_id=_ref.workflow_run_id,pod_namespace=_ref.pod_namespace,pod_name=_ref.pod_name,pod_type=_ref.pod_type;var theme=useTheme();var _useSelector=useSelector(function(state){return state.selectedNode;}),type=_useSelector.type;var _useState=useState(0),_useState2=_slicedToArray(_useState,2),selectedTab=_useState2[0],setSelectedTab=_useState2[1];var handleChange=function handleChange(event,newValue){setSelectedTab(newValue);};var classes=useStyles();var _useTranslation=useTranslation(),t=_useTranslation.t;var projectID=getProjectID();var _useQuery=useQuery(WORKFLOW_DETAILS_WITH_EXEC_DATA,{variables:{workflowRunsInput:{project_id:projectID,workflow_run_ids:[workflow_run_id]}}}),workflow_data=_useQuery.data;var workflow=workflow_data===null||workflow_data===void 0?void 0:workflow_data.getWorkflowRuns.workflow_runs[0];var _useState3=useState({exp_pod:'',runner_pod:'',chaos_namespace:''}),_useState4=_slicedToArray(_useState3,2),chaosData=_useState4[0],setChaosData=_useState4[1];useEffect(function(){if(workflow!==undefined){var nodeData=JSON.parse(workflow.execution_data).nodes[pod_name];if(nodeData&&nodeData.chaosData)setChaosData({exp_pod:nodeData.chaosData.experimentPod,runner_pod:nodeData.chaosData.runnerPod,chaos_namespace:nodeData.chaosData.namespace});else setChaosData({exp_pod:'',runner_pod:'',chaos_namespace:''});}},[workflow_data]);var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),chaosResult=_useState6[0],setChaosResult=_useState6[1];useEffect(function(){if(workflow!==undefined){var _nodeData$chaosData;var nodeData=JSON.parse(workflow.execution_data).nodes[pod_name];if(nodeData===null||nodeData===void 0?void 0:(_nodeData$chaosData=nodeData.chaosData)===null||_nodeData$chaosData===void 0?void 0:_nodeData$chaosData.chaosResult){var _nodeData$chaosData2;setChaosResult(YAML.stringify((_nodeData$chaosData2=nodeData.chaosData)===null||_nodeData$chaosData2===void 0?void 0:_nodeData$chaosData2.chaosResult));}else{setChaosResult('Chaos Result Not available');}}},[workflow_data,pod_name]);var _useSubscription=useSubscription(WORKFLOW_LOGS,{variables:{podDetails:{cluster_id:cluster_id,workflow_run_id:workflow_run_id,pod_name:pod_name,pod_namespace:pod_namespace,pod_type:pod_type,exp_pod:chaosData.exp_pod,runner_pod:chaosData.runner_pod,chaos_namespace:chaosData.chaos_namespace}}}),data=_useSubscription.data;var chaosLogs=function chaosLogs(chaoslog){var log_str='';if(Object.keys(chaoslog).length){for(var i=0;i<=Object.keys(chaoslog).length;i++){var obj=Object.keys(chaoslog)[i];if(obj!==undefined)log_str+=chaoslog[obj];}return log_str;}if(workflow!==undefined&&JSON.parse(workflow.execution_data).nodes[pod_name].type==='ChaosEngine'){return t('workflowDetailsView.nodeLogs.chaosLogs');}return'';};// Function to download the logs\nvar downloadLogs=function downloadLogs(logs,podName){var element=document.createElement('a');var chaos_logs='';try{chaos_logs=chaosLogs(logs.chaos_logs);}catch(_unused){chaos_logs='Chaos Logs unavailable';}var file=new Blob([logs===null||logs===void 0?void 0:logs.main_logs,chaos_logs],{type:'text/txt'});element.href=URL.createObjectURL(file);element.download=\"\".concat(podName,\".txt\");document.body.appendChild(element);element.click();};var parseLogs=function parseLogs(logs){try{var podLogs=JSON.parse(logs);return/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"div\",null,workflow!==undefined&&JSON.parse(workflow===null||workflow===void 0?void 0:workflow.execution_data).nodes[pod_name].type==='ChaosEngine'?/*#__PURE__*/React.createElement(ButtonFilled,{onClick:function onClick(){downloadLogs(podLogs,pod_name);},className:classes.downloadLogsBtn},/*#__PURE__*/React.createElement(Typography,null,/*#__PURE__*/React.createElement(\"img\",{src:\"/icons/download-logs.svg\",alt:\"download logs\"}),' ',t('workflowDetailsView.logs'))):/*#__PURE__*/React.createElement(React.Fragment,null),(podLogs===null||podLogs===void 0?void 0:podLogs.main_logs)!==null&&(podLogs===null||podLogs===void 0?void 0:podLogs.main_logs)!==''?/*#__PURE__*/React.createElement(\"div\",{style:{whiteSpace:'pre-wrap'}},/*#__PURE__*/React.createElement(Typography,{className:classes.text},podLogs===null||podLogs===void 0?void 0:podLogs.main_logs)):/*#__PURE__*/React.createElement(Typography,{className:classes.text},t('workflowDetailsView.nodeLogs.mainLogs'))),/*#__PURE__*/React.createElement(\"div\",null,(podLogs===null||podLogs===void 0?void 0:podLogs.chaos_logs)&&/*#__PURE__*/React.createElement(\"div\",{style:{whiteSpace:'pre-wrap'}},/*#__PURE__*/React.createElement(Typography,{className:classes.text},chaosLogs(podLogs.chaos_logs)))));}catch(_unused2){return/*#__PURE__*/React.createElement(Typography,{className:classes.text},t('workflowDetailsView.nodeLogs.couldNot'));}};useEffect(function(){if(type!=='ChaoEngine')setSelectedTab(0);},[type]);return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"div\",{className:classes.tabBar},/*#__PURE__*/React.createElement(Tabs,{value:selectedTab,onChange:handleChange,TabIndicatorProps:{style:{backgroundColor:theme.palette.highlight}}},/*#__PURE__*/React.createElement(StyledTab,{label:\"Logs\"}),type==='ChaosEngine'&&/*#__PURE__*/React.createElement(StyledTab,{label:\"Chaos Results\"}))),/*#__PURE__*/React.createElement(TabPanel,{value:selectedTab,index:0,style:{height:'100%'}},/*#__PURE__*/React.createElement(\"div\",{className:classes.logs},data!==undefined?/*#__PURE__*/React.createElement(\"div\",null,parseLogs(data.getPodLog.log)):/*#__PURE__*/React.createElement(Typography,{className:classes.text,variant:\"h5\"},t('workflowDetailsView.nodeLogs.fetching')))),type==='ChaosEngine'&&/*#__PURE__*/React.createElement(TabPanel,{value:selectedTab,index:1,style:{height:'100%'}},/*#__PURE__*/React.createElement(\"div\",{className:classes.logs},/*#__PURE__*/React.createElement(\"div\",{style:{whiteSpace:'pre-wrap'}},/*#__PURE__*/React.createElement(Typography,{className:classes.text},chaosResult)))));};export default LogsSwitcher;","map":{"version":3,"sources":["/home/vedant/go/src/github.com/litmus/litmus-portal/frontend/src/views/WorkflowDetails/LogsSwitcher/index.tsx"],"names":["useQuery","useSubscription","Tabs","Typography","useTheme","ButtonFilled","React","useEffect","useState","useTranslation","useSelector","YAML","StyledTab","TabPanel","WORKFLOW_DETAILS_WITH_EXEC_DATA","WORKFLOW_LOGS","getProjectID","useStyles","LogsSwitcher","cluster_id","workflow_run_id","pod_namespace","pod_name","pod_type","theme","state","selectedNode","type","selectedTab","setSelectedTab","handleChange","event","newValue","classes","t","projectID","variables","workflowRunsInput","project_id","workflow_run_ids","workflow_data","data","workflow","getWorkflowRuns","workflow_runs","exp_pod","runner_pod","chaos_namespace","chaosData","setChaosData","undefined","nodeData","JSON","parse","execution_data","nodes","experimentPod","runnerPod","namespace","chaosResult","setChaosResult","stringify","podDetails","chaosLogs","chaoslog","log_str","Object","keys","length","i","obj","downloadLogs","logs","podName","element","document","createElement","chaos_logs","file","Blob","main_logs","href","URL","createObjectURL","download","body","appendChild","click","parseLogs","podLogs","downloadLogsBtn","whiteSpace","text","tabBar","style","backgroundColor","palette","highlight","height","getPodLog","log"],"mappings":"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","sourcesContent":["import { useQuery, useSubscription } from '@apollo/client';\nimport { Tabs, Typography, useTheme } from '@material-ui/core';\nimport { ButtonFilled } from 'litmus-ui';\nimport React, { useEffect, useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { useSelector } from 'react-redux';\nimport YAML from 'yaml';\nimport { StyledTab, TabPanel } from '../../../components/Tabs';\nimport {\n  WORKFLOW_DETAILS_WITH_EXEC_DATA,\n  WORKFLOW_LOGS,\n} from '../../../graphql';\nimport {\n  PodLog,\n  PodLogRequest,\n  PodLogVars,\n} from '../../../models/graphql/podLog';\nimport {\n  ExecutionData,\n  Workflow,\n  WorkflowDataVars,\n} from '../../../models/graphql/workflowData';\nimport { RootState } from '../../../redux/reducers';\nimport { getProjectID } from '../../../utils/getSearchParams';\nimport useStyles from './styles';\n\ninterface ChaosDataVar {\n  exp_pod: string;\n  runner_pod: string;\n  chaos_namespace: string;\n}\n\ninterface LogsSwitcherProps extends PodLogRequest {}\n\nconst LogsSwitcher: React.FC<LogsSwitcherProps> = ({\n  cluster_id,\n  workflow_run_id,\n  pod_namespace,\n  pod_name,\n  pod_type,\n}) => {\n  const theme = useTheme();\n  const { type } = useSelector((state: RootState) => state.selectedNode);\n  const [selectedTab, setSelectedTab] = useState(0);\n  const handleChange = (event: React.ChangeEvent<{}>, newValue: number) => {\n    setSelectedTab(newValue);\n  };\n\n  const classes = useStyles();\n  const { t } = useTranslation();\n  const projectID = getProjectID();\n\n  const { data: workflow_data } = useQuery<Workflow, WorkflowDataVars>(\n    WORKFLOW_DETAILS_WITH_EXEC_DATA,\n    {\n      variables: {\n        workflowRunsInput: {\n          project_id: projectID,\n          workflow_run_ids: [workflow_run_id],\n        },\n      },\n    }\n  );\n\n  const workflow = workflow_data?.getWorkflowRuns.workflow_runs[0];\n\n  const [chaosData, setChaosData] = useState<ChaosDataVar>({\n    exp_pod: '',\n    runner_pod: '',\n    chaos_namespace: '',\n  });\n\n  useEffect(() => {\n    if (workflow !== undefined) {\n      const nodeData = (JSON.parse(workflow.execution_data) as ExecutionData)\n        .nodes[pod_name];\n      if (nodeData && nodeData.chaosData)\n        setChaosData({\n          exp_pod: nodeData.chaosData.experimentPod,\n          runner_pod: nodeData.chaosData.runnerPod,\n          chaos_namespace: nodeData.chaosData.namespace,\n        });\n      else\n        setChaosData({\n          exp_pod: '',\n          runner_pod: '',\n          chaos_namespace: '',\n        });\n    }\n  }, [workflow_data]);\n\n  const [chaosResult, setChaosResult] = useState('');\n\n  useEffect(() => {\n    if (workflow !== undefined) {\n      const nodeData = (JSON.parse(workflow.execution_data) as ExecutionData)\n        .nodes[pod_name];\n      if (nodeData?.chaosData?.chaosResult) {\n        setChaosResult(YAML.stringify(nodeData.chaosData?.chaosResult));\n      } else {\n        setChaosResult('Chaos Result Not available');\n      }\n    }\n  }, [workflow_data, pod_name]);\n\n  const { data } = useSubscription<PodLog, PodLogVars>(WORKFLOW_LOGS, {\n    variables: {\n      podDetails: {\n        cluster_id,\n        workflow_run_id,\n        pod_name,\n        pod_namespace,\n        pod_type,\n        exp_pod: chaosData.exp_pod,\n        runner_pod: chaosData.runner_pod,\n        chaos_namespace: chaosData.chaos_namespace,\n      },\n    },\n  });\n\n  const chaosLogs = (chaoslog: any) => {\n    let log_str = '';\n    if (Object.keys(chaoslog).length) {\n      for (let i = 0; i <= Object.keys(chaoslog).length; i++) {\n        const obj = Object.keys(chaoslog)[i];\n        if (obj !== undefined) log_str += chaoslog[obj];\n      }\n      return log_str;\n    }\n    if (\n      workflow !== undefined &&\n      (JSON.parse(workflow.execution_data) as ExecutionData).nodes[pod_name]\n        .type === 'ChaosEngine'\n    ) {\n      return t('workflowDetailsView.nodeLogs.chaosLogs');\n    }\n    return '';\n  };\n\n  // Function to download the logs\n  const downloadLogs = (logs: any, podName: string) => {\n    const element = document.createElement('a');\n    let chaos_logs = '';\n    try {\n      chaos_logs = chaosLogs(logs.chaos_logs);\n    } catch {\n      chaos_logs = 'Chaos Logs unavailable';\n    }\n    const file = new Blob([logs?.main_logs, chaos_logs], {\n      type: 'text/txt',\n    });\n    element.href = URL.createObjectURL(file);\n    element.download = `${podName}.txt`;\n    document.body.appendChild(element);\n    element.click();\n  };\n\n  const parseLogs = (logs: string) => {\n    try {\n      const podLogs = JSON.parse(logs);\n      return (\n        <div>\n          <div>\n            {workflow !== undefined &&\n            JSON.parse(workflow?.execution_data).nodes[pod_name].type ===\n              'ChaosEngine' ? (\n              <ButtonFilled\n                onClick={() => {\n                  downloadLogs(podLogs, pod_name);\n                }}\n                className={classes.downloadLogsBtn}\n              >\n                <Typography>\n                  <img src=\"/icons/download-logs.svg\" alt=\"download logs\" />{' '}\n                  {t('workflowDetailsView.logs')}\n                </Typography>\n              </ButtonFilled>\n            ) : (\n              <></>\n            )}\n            {podLogs?.main_logs !== null && podLogs?.main_logs !== '' ? (\n              <div style={{ whiteSpace: 'pre-wrap' }}>\n                <Typography className={classes.text}>\n                  {podLogs?.main_logs}\n                </Typography>\n              </div>\n            ) : (\n              <Typography className={classes.text}>\n                {t('workflowDetailsView.nodeLogs.mainLogs')}\n              </Typography>\n            )}\n          </div>\n          <div>\n            {podLogs?.chaos_logs && (\n              <div style={{ whiteSpace: 'pre-wrap' }}>\n                <Typography className={classes.text}>\n                  {chaosLogs(podLogs.chaos_logs)}\n                </Typography>\n              </div>\n            )}\n          </div>\n        </div>\n      );\n    } catch {\n      return (\n        <Typography className={classes.text}>\n          {t('workflowDetailsView.nodeLogs.couldNot')}\n        </Typography>\n      );\n    }\n  };\n\n  useEffect(() => {\n    if (type !== 'ChaoEngine') setSelectedTab(0);\n  }, [type]);\n\n  return (\n    <>\n      <div className={classes.tabBar}>\n        <Tabs\n          value={selectedTab}\n          onChange={handleChange}\n          TabIndicatorProps={{\n            style: {\n              backgroundColor: theme.palette.highlight,\n            },\n          }}\n        >\n          <StyledTab label=\"Logs\" />\n          {type === 'ChaosEngine' && <StyledTab label=\"Chaos Results\" />}\n        </Tabs>\n      </div>\n      <TabPanel value={selectedTab} index={0} style={{ height: '100%' }}>\n        <div className={classes.logs}>\n          {data !== undefined ? (\n            <div>{parseLogs(data.getPodLog.log)}</div>\n          ) : (\n            <Typography className={classes.text} variant=\"h5\">\n              {t('workflowDetailsView.nodeLogs.fetching')}\n            </Typography>\n          )}\n        </div>\n      </TabPanel>\n      {type === 'ChaosEngine' && (\n        <TabPanel value={selectedTab} index={1} style={{ height: '100%' }}>\n          <div className={classes.logs}>\n            <div style={{ whiteSpace: 'pre-wrap' }}>\n              <Typography className={classes.text}>{chaosResult}</Typography>\n            </div>\n          </div>\n        </TabPanel>\n      )}\n    </>\n  );\n};\n\nexport default LogsSwitcher;\n"]},"metadata":{},"sourceType":"module"}
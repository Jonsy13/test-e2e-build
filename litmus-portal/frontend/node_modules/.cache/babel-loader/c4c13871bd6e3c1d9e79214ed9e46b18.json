{"ast":null,"code":"import _objectSpread from\"/home/vedant/go/src/github.com/litmus/litmus-portal/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"/home/vedant/go/src/github.com/litmus/litmus-portal/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useQuery}from'@apollo/client';import{IconButton,Paper,Table,TableBody,TableCell,TableContainer,TableHead,TablePagination,TableRow,Typography}from'@material-ui/core';import ExpandLessIcon from'@material-ui/icons/ExpandLess';import ExpandMoreIcon from'@material-ui/icons/ExpandMore';import moment from'moment';import React,{useEffect,useState}from'react';import{useTranslation}from'react-i18next';import{GET_CLUSTER_NAMES,WORKFLOW_DETAILS,WORKFLOW_EVENTS}from'../../../graphql';import{getProjectID}from'../../../utils/getSearchParams';import HeaderSection from'./HeaderSection';import useStyles from'./styles';import TableData from'./TableData';var BrowseWorkflow=function BrowseWorkflow(){var _data$getWorkflowRuns;var classes=useStyles();var projectID=getProjectID();var _useTranslation=useTranslation(),t=_useTranslation.t;// State for pagination\nvar _useState=useState({page:0,limit:10}),_useState2=_slicedToArray(_useState,2),paginationData=_useState2[0],setPaginationData=_useState2[1];// States for filters\nvar _useState3=useState({workflow_name:'',cluster_name:'All',workflow_status:'All',date_range:{start_date:new Date(0).valueOf().toString()}}),_useState4=_slicedToArray(_useState3,2),filters=_useState4[0],setFilters=_useState4[1];// State for date to be displayed\nvar _React$useState=React.useState(t('chaosWorkflows.browseWorkflows.dateFilterHelperText')),_React$useState2=_slicedToArray(_React$useState,2),displayDate=_React$useState2[0],setDisplayDate=_React$useState2[1];// State for sorting\nvar _useState5=useState({field:'Time',descending:true}),_useState6=_slicedToArray(_useState5,2),sortData=_useState6[0],setSortData=_useState6[1];// Checks if the workflow event from subscription exists in the table\nfunction isFiltered(newWorkflow){var nameExists=filters.workflow_name&&newWorkflow.workflow_name.toLowerCase().includes(filters.workflow_name.toLowerCase());var clusterExists=filters.cluster_name==='All'||filters.cluster_name===newWorkflow.cluster_name;var phaseExists=filters.workflow_status==='All'||filters.workflow_status===newWorkflow.phase;var dateExists=filters.date_range&&newWorkflow.last_updated>=filters.date_range.start_date&&(filters.date_range.end_date?newWorkflow.last_updated<filters.date_range.end_date:true);var shouldAddNewWorkflow=nameExists&&clusterExists&&phaseExists&&dateExists;return shouldAddNewWorkflow;}// Query to get list of Clusters\nvar _useQuery=useQuery(GET_CLUSTER_NAMES,{variables:{project_id:projectID}}),clusterList=_useQuery.data;// Query to get workflows\nvar _useQuery2=useQuery(WORKFLOW_DETAILS,{variables:{workflowRunsInput:{project_id:projectID,pagination:{page:paginationData.page,limit:paginationData.limit},sort:sortData,filter:filters}},fetchPolicy:'cache-and-network'}),subscribeToMore=_useQuery2.subscribeToMore,data=_useQuery2.data,error=_useQuery2.error,refetch=_useQuery2.refetch;// Using subscription to get realtime data\nuseEffect(function(){subscribeToMore({document:WORKFLOW_EVENTS,variables:{projectID:projectID},updateQuery:function updateQuery(prev,_ref){var subscriptionData=_ref.subscriptionData;if(!subscriptionData.data||!prev||!prev.getWorkflowRuns)return prev;var modifiedWorkflows=prev.getWorkflowRuns.workflow_runs.slice();var newWorkflow=subscriptionData.data.workflowEventListener;// Updating the query data\nvar i=0;var totalNoOfWorkflows=prev.getWorkflowRuns.total_no_of_workflow_runs;for(;i<modifiedWorkflows.length;i++){if(modifiedWorkflows[i].workflow_run_id===newWorkflow.workflow_run_id){modifiedWorkflows[i]=newWorkflow;break;}}if(i===modifiedWorkflows.length&&isFiltered(newWorkflow)){totalNoOfWorkflows++;modifiedWorkflows.unshift(newWorkflow);}return{getWorkflowRuns:{total_no_of_workflow_runs:totalNoOfWorkflows,workflow_runs:modifiedWorkflows}};}});},[data]);var _React$useState3=React.useState(null),_React$useState4=_slicedToArray(_React$useState3,2),popAnchorEl=_React$useState4[0],setPopAnchorEl=_React$useState4[1];var isOpen=Boolean(popAnchorEl);var _React$useState5=React.useState(false),_React$useState6=_slicedToArray(_React$useState5,2),open=_React$useState6[0],setOpen=_React$useState6[1];var handlePopOverClose=function handlePopOverClose(){setPopAnchorEl(null);setOpen(false);};var handlePopOverClick=function handlePopOverClick(event){setPopAnchorEl(event.currentTarget);setOpen(true);};var workflowRuns=data===null||data===void 0?void 0:data.getWorkflowRuns.workflow_runs;// Functions passed as props in the headerSection\nvar changeSearch=function changeSearch(event){setFilters(_objectSpread(_objectSpread({},filters),{},{workflow_name:event.target.value}));setPaginationData(_objectSpread(_objectSpread({},paginationData),{},{page:0}));};var changeStatus=function changeStatus(event){setFilters(_objectSpread(_objectSpread({},filters),{},{workflow_status:event.target.value}));setPaginationData(_objectSpread(_objectSpread({},paginationData),{},{page:0}));};var changeCluster=function changeCluster(event){setFilters(_objectSpread(_objectSpread({},filters),{},{cluster_name:event.target.value}));setPaginationData(_objectSpread(_objectSpread({},paginationData),{},{page:0}));};// Function to set the date range for filtering\nvar dateChange=function dateChange(selectStartDate,selectEndDate){// Change filter value for date range\nsetFilters(_objectSpread(_objectSpread({},filters),{},{date_range:{start_date:new Date(selectStartDate).setHours(0,0,0).valueOf().toString(),end_date:new Date(selectEndDate).setHours(23,59,59).valueOf().toString()}}));// Change the display value of date range\nsetDisplayDate(\"\".concat(moment(selectStartDate).format('DD.MM.YYYY').toString(),\"-\").concat(moment(selectEndDate).format('DD.MM.YYYY').toString()));};return/*#__PURE__*/React.createElement(\"div\",{\"data-cy\":\"WorkflowRunsTable\"},/*#__PURE__*/React.createElement(\"section\",{className:\"Heading section\"},/*#__PURE__*/React.createElement(HeaderSection,{searchValue:filters.workflow_name,changeSearch:changeSearch,statusValue:filters.workflow_status,changeStatus:changeStatus,clusterValue:filters.cluster_name,changeCluster:changeCluster,popOverClick:handlePopOverClick,popOverClose:handlePopOverClose,isOpen:isOpen,clusterList:clusterList,popAnchorEl:popAnchorEl,isDateOpen:open,displayDate:displayDate,selectDate:dateChange})),/*#__PURE__*/React.createElement(Paper,{className:classes.root},/*#__PURE__*/React.createElement(TableContainer,{\"data-cy\":\"browseWorkflowTable\",className:classes.tableMain},/*#__PURE__*/React.createElement(Table,{stickyHeader:true,\"aria-label\":\"simple table\"},/*#__PURE__*/React.createElement(TableHead,{className:classes.tableHead},/*#__PURE__*/React.createElement(TableRow,null,/*#__PURE__*/React.createElement(TableCell,null),/*#__PURE__*/React.createElement(TableCell,{className:classes.headerStatus},t('chaosWorkflows.browseWorkflows.status')),/*#__PURE__*/React.createElement(TableCell,{className:classes.workflowName},/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',flexDirection:'row'}},/*#__PURE__*/React.createElement(Typography,{className:classes.paddedTypography},t('chaosWorkflows.browseWorkflows.name')),/*#__PURE__*/React.createElement(\"div\",{className:classes.sortDiv},/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"sort name ascending\",size:\"small\",onClick:function onClick(){return setSortData({field:'Name'});}},/*#__PURE__*/React.createElement(ExpandLessIcon,{fontSize:\"inherit\"})),/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"sort name descending\",size:\"small\",onClick:function onClick(){return setSortData({field:'Name',descending:true});}},/*#__PURE__*/React.createElement(ExpandMoreIcon,{fontSize:\"inherit\"}))))),/*#__PURE__*/React.createElement(TableCell,null,/*#__PURE__*/React.createElement(Typography,{className:classes.targetCluster},t('chaosWorkflows.browseWorkflows.targetAgent'))),/*#__PURE__*/React.createElement(TableCell,null,/*#__PURE__*/React.createElement(Typography,{className:classes.paddedTypography},t('chaosWorkflows.browseWorkflows.reliabilityDetails'))),/*#__PURE__*/React.createElement(TableCell,null,/*#__PURE__*/React.createElement(Typography,{className:classes.paddedTypography},t('chaosWorkflows.browseWorkflows.experiments'))),/*#__PURE__*/React.createElement(TableCell,null,/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',flexDirection:'row'}},/*#__PURE__*/React.createElement(Typography,{className:classes.paddedTypography},t('chaosWorkflows.browseWorkflows.lastRun')),/*#__PURE__*/React.createElement(\"div\",{className:classes.sortDiv},/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"sort last run ascending\",size:\"small\",onClick:function onClick(){return setSortData({field:'Time',descending:true});}},/*#__PURE__*/React.createElement(ExpandLessIcon,{fontSize:\"inherit\"})),/*#__PURE__*/React.createElement(IconButton,{\"aria-label\":\"sort last run descending\",size:\"small\",onClick:function onClick(){return setSortData({field:'Time'});}},/*#__PURE__*/React.createElement(ExpandMoreIcon,{fontSize:\"inherit\"}))))),/*#__PURE__*/React.createElement(TableCell,null))),/*#__PURE__*/React.createElement(TableBody,null,error?/*#__PURE__*/React.createElement(TableRow,null,/*#__PURE__*/React.createElement(TableCell,{colSpan:7},/*#__PURE__*/React.createElement(Typography,{\"data-cy\":\"browseWorkflowError\",align:\"center\"},\"Unable to fetch data\"))):workflowRuns&&workflowRuns.length?workflowRuns.map(function(dataRow){return/*#__PURE__*/React.createElement(TableRow,{\"data-cy\":\"WorkflowRunsTableRow\",key:dataRow.workflow_run_id},/*#__PURE__*/React.createElement(TableData,{data:dataRow,refetchQuery:refetch}));}):/*#__PURE__*/React.createElement(TableRow,null,/*#__PURE__*/React.createElement(TableCell,{colSpan:7},/*#__PURE__*/React.createElement(Typography,{\"data-cy\":\"browseWorkflowNoData\",align:\"center\"},\"No records available\")))))),/*#__PURE__*/React.createElement(TablePagination,{rowsPerPageOptions:[10,25,50],component:\"div\",count:(_data$getWorkflowRuns=data===null||data===void 0?void 0:data.getWorkflowRuns.total_no_of_workflow_runs)!==null&&_data$getWorkflowRuns!==void 0?_data$getWorkflowRuns:0,rowsPerPage:paginationData.limit,page:paginationData.page,onChangePage:function onChangePage(_,page){return setPaginationData(_objectSpread(_objectSpread({},paginationData),{},{page:page}));},onChangeRowsPerPage:function onChangeRowsPerPage(event){return setPaginationData(_objectSpread(_objectSpread({},paginationData),{},{page:0,limit:parseInt(event.target.value,10)}));}})));};export default BrowseWorkflow;","map":{"version":3,"sources":["/home/vedant/go/src/github.com/litmus/litmus-portal/frontend/src/views/ChaosWorkflows/BrowseWorkflow/index.tsx"],"names":["useQuery","IconButton","Paper","Table","TableBody","TableCell","TableContainer","TableHead","TablePagination","TableRow","Typography","ExpandLessIcon","ExpandMoreIcon","moment","React","useEffect","useState","useTranslation","GET_CLUSTER_NAMES","WORKFLOW_DETAILS","WORKFLOW_EVENTS","getProjectID","HeaderSection","useStyles","TableData","BrowseWorkflow","classes","projectID","t","page","limit","paginationData","setPaginationData","workflow_name","cluster_name","workflow_status","date_range","start_date","Date","valueOf","toString","filters","setFilters","displayDate","setDisplayDate","field","descending","sortData","setSortData","isFiltered","newWorkflow","nameExists","toLowerCase","includes","clusterExists","phaseExists","phase","dateExists","last_updated","end_date","shouldAddNewWorkflow","variables","project_id","clusterList","data","workflowRunsInput","pagination","sort","filter","fetchPolicy","subscribeToMore","error","refetch","document","updateQuery","prev","subscriptionData","getWorkflowRuns","modifiedWorkflows","workflow_runs","slice","workflowEventListener","i","totalNoOfWorkflows","total_no_of_workflow_runs","length","workflow_run_id","unshift","popAnchorEl","setPopAnchorEl","isOpen","Boolean","open","setOpen","handlePopOverClose","handlePopOverClick","event","currentTarget","workflowRuns","changeSearch","target","value","changeStatus","changeCluster","dateChange","selectStartDate","selectEndDate","setHours","format","root","tableMain","tableHead","headerStatus","workflowName","display","flexDirection","paddedTypography","sortDiv","targetCluster","map","dataRow","_","parseInt"],"mappings":"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","sourcesContent":["import { useQuery } from '@apollo/client';\nimport {\n  IconButton,\n  Paper,\n  Table,\n  TableBody,\n  TableCell,\n  TableContainer,\n  TableHead,\n  TablePagination,\n  TableRow,\n  Typography,\n} from '@material-ui/core';\nimport ExpandLessIcon from '@material-ui/icons/ExpandLess';\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\nimport moment from 'moment';\nimport React, { useEffect, useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport {\n  GET_CLUSTER_NAMES,\n  WORKFLOW_DETAILS,\n  WORKFLOW_EVENTS,\n} from '../../../graphql';\nimport { Clusters, ClusterVars } from '../../../models/graphql/clusterData';\nimport {\n  Pagination,\n  SortInput,\n  Workflow,\n  WorkflowDataVars,\n  WorkflowRun,\n  WorkflowRunFilterInput,\n  WorkflowStatus,\n  WorkflowSubscription,\n  WorkflowSubscriptionInput,\n} from '../../../models/graphql/workflowData';\nimport { getProjectID } from '../../../utils/getSearchParams';\nimport HeaderSection from './HeaderSection';\nimport useStyles from './styles';\nimport TableData from './TableData';\n\nconst BrowseWorkflow: React.FC = () => {\n  const classes = useStyles();\n  const projectID = getProjectID();\n  const { t } = useTranslation();\n\n  // State for pagination\n  const [paginationData, setPaginationData] = useState<Pagination>({\n    page: 0,\n    limit: 10,\n  });\n\n  // States for filters\n  const [filters, setFilters] = useState<WorkflowRunFilterInput>({\n    workflow_name: '',\n    cluster_name: 'All',\n    workflow_status: 'All',\n    date_range: {\n      start_date: new Date(0).valueOf().toString(),\n    },\n  });\n\n  // State for date to be displayed\n  const [displayDate, setDisplayDate] = React.useState<string>(\n    t('chaosWorkflows.browseWorkflows.dateFilterHelperText')\n  );\n\n  // State for sorting\n  const [sortData, setSortData] = useState<SortInput>({\n    field: 'Time',\n    descending: true,\n  });\n\n  // Checks if the workflow event from subscription exists in the table\n  function isFiltered(newWorkflow: WorkflowRun) {\n    const nameExists =\n      filters.workflow_name &&\n      newWorkflow.workflow_name\n        .toLowerCase()\n        .includes(filters.workflow_name.toLowerCase());\n\n    const clusterExists =\n      filters.cluster_name === 'All' ||\n      filters.cluster_name === newWorkflow.cluster_name;\n\n    const phaseExists =\n      filters.workflow_status === 'All' ||\n      filters.workflow_status === newWorkflow.phase;\n\n    const dateExists =\n      filters.date_range &&\n      newWorkflow.last_updated >= filters.date_range.start_date &&\n      (filters.date_range.end_date\n        ? newWorkflow.last_updated < filters.date_range.end_date\n        : true);\n\n    const shouldAddNewWorkflow =\n      nameExists && clusterExists && phaseExists && dateExists;\n\n    return shouldAddNewWorkflow;\n  }\n\n  // Query to get list of Clusters\n  const { data: clusterList } = useQuery<Partial<Clusters>, ClusterVars>(\n    GET_CLUSTER_NAMES,\n    {\n      variables: {\n        project_id: projectID,\n      },\n    }\n  );\n\n  // Query to get workflows\n  const { subscribeToMore, data, error, refetch } = useQuery<\n    Workflow,\n    WorkflowDataVars\n  >(WORKFLOW_DETAILS, {\n    variables: {\n      workflowRunsInput: {\n        project_id: projectID,\n        pagination: {\n          page: paginationData.page,\n          limit: paginationData.limit,\n        },\n        sort: sortData,\n        filter: filters,\n      },\n    },\n    fetchPolicy: 'cache-and-network',\n  });\n\n  // Using subscription to get realtime data\n  useEffect(() => {\n    subscribeToMore<WorkflowSubscription, WorkflowSubscriptionInput>({\n      document: WORKFLOW_EVENTS,\n      variables: { projectID },\n      updateQuery: (prev, { subscriptionData }) => {\n        if (!subscriptionData.data || !prev || !prev.getWorkflowRuns)\n          return prev;\n\n        const modifiedWorkflows = prev.getWorkflowRuns.workflow_runs.slice();\n        const newWorkflow = subscriptionData.data.workflowEventListener;\n\n        // Updating the query data\n        let i = 0;\n        let totalNoOfWorkflows = prev.getWorkflowRuns.total_no_of_workflow_runs;\n\n        for (; i < modifiedWorkflows.length; i++) {\n          if (\n            modifiedWorkflows[i].workflow_run_id === newWorkflow.workflow_run_id\n          ) {\n            modifiedWorkflows[i] = newWorkflow;\n            break;\n          }\n        }\n        if (i === modifiedWorkflows.length && isFiltered(newWorkflow)) {\n          totalNoOfWorkflows++;\n          modifiedWorkflows.unshift(newWorkflow);\n        }\n\n        return {\n          getWorkflowRuns: {\n            total_no_of_workflow_runs: totalNoOfWorkflows,\n            workflow_runs: modifiedWorkflows,\n          },\n        };\n      },\n    });\n  }, [data]);\n\n  const [popAnchorEl, setPopAnchorEl] = React.useState<null | HTMLElement>(\n    null\n  );\n  const isOpen = Boolean(popAnchorEl);\n\n  const [open, setOpen] = React.useState<boolean>(false);\n\n  const handlePopOverClose = () => {\n    setPopAnchorEl(null);\n    setOpen(false);\n  };\n  const handlePopOverClick = (event: React.MouseEvent<HTMLElement>) => {\n    setPopAnchorEl(event.currentTarget);\n    setOpen(true);\n  };\n\n  const workflowRuns = data?.getWorkflowRuns.workflow_runs;\n\n  // Functions passed as props in the headerSection\n  const changeSearch = (\n    event: React.ChangeEvent<HTMLTextAreaElement | HTMLInputElement>\n  ) => {\n    setFilters({ ...filters, workflow_name: event.target.value as string });\n    setPaginationData({ ...paginationData, page: 0 });\n  };\n\n  const changeStatus = (\n    event: React.ChangeEvent<{\n      name?: string | undefined;\n      value: unknown;\n    }>\n  ) => {\n    setFilters({\n      ...filters,\n      workflow_status: event.target.value as WorkflowStatus,\n    });\n    setPaginationData({ ...paginationData, page: 0 });\n  };\n\n  const changeCluster = (\n    event: React.ChangeEvent<{\n      name?: string | undefined;\n      value: unknown;\n    }>\n  ) => {\n    setFilters({ ...filters, cluster_name: event.target.value as string });\n    setPaginationData({ ...paginationData, page: 0 });\n  };\n\n  // Function to set the date range for filtering\n  const dateChange = (selectStartDate: string, selectEndDate: string) => {\n    // Change filter value for date range\n    setFilters({\n      ...filters,\n      date_range: {\n        start_date: new Date(selectStartDate)\n          .setHours(0, 0, 0)\n          .valueOf()\n          .toString(),\n        end_date: new Date(selectEndDate)\n          .setHours(23, 59, 59)\n          .valueOf()\n          .toString(),\n      },\n    });\n\n    // Change the display value of date range\n    setDisplayDate(\n      `${moment(selectStartDate).format('DD.MM.YYYY').toString()}-${moment(\n        selectEndDate\n      )\n        .format('DD.MM.YYYY')\n        .toString()}`\n    );\n  };\n\n  return (\n    <div data-cy=\"WorkflowRunsTable\">\n      <section className=\"Heading section\">\n        {/* Header Section */}\n        <HeaderSection\n          searchValue={filters.workflow_name}\n          changeSearch={changeSearch}\n          statusValue={filters.workflow_status}\n          changeStatus={changeStatus}\n          clusterValue={filters.cluster_name}\n          changeCluster={changeCluster}\n          popOverClick={handlePopOverClick}\n          popOverClose={handlePopOverClose}\n          isOpen={isOpen}\n          clusterList={clusterList}\n          popAnchorEl={popAnchorEl}\n          isDateOpen={open}\n          displayDate={displayDate}\n          selectDate={dateChange}\n        />\n      </section>\n      <Paper className={classes.root}>\n        <TableContainer\n          data-cy=\"browseWorkflowTable\"\n          className={classes.tableMain}\n        >\n          <Table stickyHeader aria-label=\"simple table\">\n            <TableHead className={classes.tableHead}>\n              <TableRow>\n                <TableCell />\n                {/* Status */}\n                <TableCell className={classes.headerStatus}>\n                  {t('chaosWorkflows.browseWorkflows.status')}\n                </TableCell>\n\n                {/* Workflow Name */}\n                <TableCell className={classes.workflowName}>\n                  <div style={{ display: 'flex', flexDirection: 'row' }}>\n                    <Typography className={classes.paddedTypography}>\n                      {t('chaosWorkflows.browseWorkflows.name')}\n                    </Typography>\n                    <div className={classes.sortDiv}>\n                      <IconButton\n                        aria-label=\"sort name ascending\"\n                        size=\"small\"\n                        onClick={() =>\n                          setSortData({\n                            field: 'Name',\n                          })\n                        }\n                      >\n                        <ExpandLessIcon fontSize=\"inherit\" />\n                      </IconButton>\n                      <IconButton\n                        aria-label=\"sort name descending\"\n                        size=\"small\"\n                        onClick={() =>\n                          setSortData({\n                            field: 'Name',\n                            descending: true,\n                          })\n                        }\n                      >\n                        <ExpandMoreIcon fontSize=\"inherit\" />\n                      </IconButton>\n                    </div>\n                  </div>\n                </TableCell>\n\n                {/* Target Agent */}\n                <TableCell>\n                  <Typography className={classes.targetCluster}>\n                    {t('chaosWorkflows.browseWorkflows.targetAgent')}\n                  </Typography>\n                </TableCell>\n\n                {/* Reliability Details */}\n                <TableCell>\n                  <Typography className={classes.paddedTypography}>\n                    {t('chaosWorkflows.browseWorkflows.reliabilityDetails')}\n                  </Typography>\n                </TableCell>\n\n                {/* Experiments */}\n                <TableCell>\n                  <Typography className={classes.paddedTypography}>\n                    {t('chaosWorkflows.browseWorkflows.experiments')}\n                  </Typography>\n                </TableCell>\n\n                {/* Last Run */}\n                <TableCell>\n                  <div style={{ display: 'flex', flexDirection: 'row' }}>\n                    <Typography className={classes.paddedTypography}>\n                      {t('chaosWorkflows.browseWorkflows.lastRun')}\n                    </Typography>\n                    <div className={classes.sortDiv}>\n                      <IconButton\n                        aria-label=\"sort last run ascending\"\n                        size=\"small\"\n                        onClick={() =>\n                          setSortData({\n                            field: 'Time',\n                            descending: true,\n                          })\n                        }\n                      >\n                        <ExpandLessIcon fontSize=\"inherit\" />\n                      </IconButton>\n                      <IconButton\n                        aria-label=\"sort last run descending\"\n                        size=\"small\"\n                        onClick={() =>\n                          setSortData({\n                            field: 'Time',\n                          })\n                        }\n                      >\n                        <ExpandMoreIcon fontSize=\"inherit\" />\n                      </IconButton>\n                    </div>\n                  </div>\n                </TableCell>\n\n                {/* Menu Cell */}\n                <TableCell />\n              </TableRow>\n            </TableHead>\n\n            {/* Body */}\n            <TableBody>\n              {error ? (\n                <TableRow>\n                  <TableCell colSpan={7}>\n                    <Typography data-cy=\"browseWorkflowError\" align=\"center\">\n                      Unable to fetch data\n                    </Typography>\n                  </TableCell>\n                </TableRow>\n              ) : workflowRuns && workflowRuns.length ? (\n                workflowRuns.map((dataRow) => (\n                  <TableRow\n                    data-cy=\"WorkflowRunsTableRow\"\n                    key={dataRow.workflow_run_id}\n                  >\n                    <TableData data={dataRow} refetchQuery={refetch} />\n                  </TableRow>\n                ))\n              ) : (\n                <TableRow>\n                  <TableCell colSpan={7}>\n                    <Typography data-cy=\"browseWorkflowNoData\" align=\"center\">\n                      No records available\n                    </Typography>\n                  </TableCell>\n                </TableRow>\n              )}\n            </TableBody>\n          </Table>\n        </TableContainer>\n\n        {/* Pagination */}\n        <TablePagination\n          rowsPerPageOptions={[10, 25, 50]}\n          component=\"div\"\n          count={data?.getWorkflowRuns.total_no_of_workflow_runs ?? 0}\n          rowsPerPage={paginationData.limit}\n          page={paginationData.page}\n          onChangePage={(_, page) =>\n            setPaginationData({ ...paginationData, page })\n          }\n          onChangeRowsPerPage={(event) =>\n            setPaginationData({\n              ...paginationData,\n              page: 0,\n              limit: parseInt(event.target.value, 10),\n            })\n          }\n        />\n      </Paper>\n    </div>\n  );\n};\n\nexport default BrowseWorkflow;\n"]},"metadata":{},"sourceType":"module"}